import 'dart:convert';

/// ุงุฎุชุจุงุฑ ุดุงูู ููุธุงู ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ
/// ูุฐุง ุงูุงุฎุชุจุงุฑ ูุญุงูู ุฌููุน ุงูุนูููุงุช ุงูุชู ูููู ุจูุง ุงูุชุทุจูู
void main() {
  print('๐ ุจุฏุก ุงูุงุฎุชุจุงุฑ ุงูุดุงูู ููุธุงู ุงููุณุฎ ุงูุงุญุชูุงุทู...\n');

  // ุจูุงูุงุช ุชุฌุฑูุจูุฉ ุดุงููุฉ
  final testBackupData = {
    'version': '1.0',
    'exported_at': DateTime.now().toIso8601String(),
    'data': {
      'companies_count': 3,
      'accounts_count': 5,
      'transactions_count': 8,

      // ุจูุงูุงุช ุงูุดุฑูุงุช
      'companies': [
        {
          'name': 'ุดุฑูุฉ ุงูุชููุฒ ููููุงููุงุช',
          'ownerId': 'ID001',
          'ownerPhone': '0551234567',
          'ownerExtra': [
            {'ููุน ุงููููุฉ': 'ุฅูุงูุฉ', 'ุฑูู ุงููููุฉ': '2234567890'},
          ],
          'companyData': [
            {'ููุน ุงููุดุงุท': 'ููุงููุงุช', 'ุณุฌู ุชุฌุงุฑู': '1234567890'},
          ],
          'workers': [
            {'name': 'ุฃุญูุฏ ูุญูุฏ', 'nationality': 'ูุตุฑู', 'phone': '0551111111'},
            {'name': 'ูุญูุฏ ุนูู', 'nationality': 'ุณูุฑู', 'phone': '0552222222'},
          ],
          'isArchived': false,
          'companyAttachments': [],
        },
        {
          'name': 'ูุคุณุณุฉ ุงูุจูุงุก ุงูุญุฏูุซ',
          'ownerId': 'ID002',
          'ownerPhone': '0553456789',
          'ownerExtra': [
            {'ููุน ุงููููุฉ': 'ูููุฉ ูุทููุฉ', 'ุฑูู ุงููููุฉ': '1123456789'},
          ],
          'companyData': [
            {'ููุน ุงููุดุงุท': 'ุฅูุดุงุกุงุช', 'ุณุฌู ุชุฌุงุฑู': '9876543210'},
          ],
          'workers': [
            {
              'name': 'ุฎุงูุฏ ุฃุญูุฏ',
              'nationality': 'ุฃุฑุฏูู',
              'phone': '0553333333',
            },
          ],
          'isArchived': false,
          'companyAttachments': [],
        },
        {
          'name': 'ุดุฑูุฉ ูุคุฑุดูุฉ',
          'ownerId': 'ID003',
          'ownerPhone': '0555555555',
          'ownerExtra': [],
          'companyData': [],
          'workers': [],
          'isArchived': true,
          'companyAttachments': [],
        },
      ],

      // ุจูุงูุงุช ุงูุญุณุงุจุงุช
      'accounts': [
        {
          'name': 'ุญุณุงุจ ูุคุณุณุฉ ุงูุชููุฒ',
          'totalDue': 50000.0,
          'totalPaid': 30000.0,
          'remaining': 20000.0,
          'dueDate': '2025-12-31T00:00:00.000Z',
          'items': [
            {'description': 'ูุณุชุญูุงุช ุดูุฑ ููุงูุฑ', 'amount': 25000.0},
            {'description': 'ูุณุชุญูุงุช ุดูุฑ ูุจุฑุงูุฑ', 'amount': 25000.0},
          ],
          'lastModified': DateTime.now().toIso8601String(),
          'documents': [
            {
              'name': 'ุฌูุงุฒ ุณูุฑ',
              'number': 'A1234567',
              'expiryDate': '2025-12-31T00:00:00.000Z',
              'createdAt': DateTime.now().toIso8601String(),
            },
          ],
        },
        {
          'name': 'ุญุณุงุจ ุงูุจูุงุก ุงูุญุฏูุซ',
          'totalDue': 75000.0,
          'totalPaid': 50000.0,
          'remaining': 25000.0,
          'dueDate': '2025-11-30T00:00:00.000Z',
          'items': [
            {'description': 'ุนูุฏ ููุงููุฉ ุฑูู 1', 'amount': 75000.0},
          ],
          'lastModified': DateTime.now().toIso8601String(),
          'documents': [],
        },
        {
          'name': 'ุญุณุงุจ ูุณุชุญู',
          'totalDue': 15000.0,
          'totalPaid': 0.0,
          'remaining': 15000.0,
          'dueDate': '2025-09-15T00:00:00.000Z',
          'items': [],
          'lastModified': DateTime.now().toIso8601String(),
          'documents': [],
        },
        {
          'name': 'ุญุณุงุจ ูุณุฏุฏ ุจุงููุงูู',
          'totalDue': 20000.0,
          'totalPaid': 20000.0,
          'remaining': 0.0,
          'dueDate': '2025-08-01T00:00:00.000Z',
          'items': [],
          'lastModified': DateTime.now().toIso8601String(),
          'documents': [],
        },
        {
          'name': 'ุญุณุงุจ ุจูุซุงุฆู ูุชุนุฏุฏุฉ',
          'totalDue': 30000.0,
          'totalPaid': 15000.0,
          'remaining': 15000.0,
          'dueDate': '2025-10-31T00:00:00.000Z',
          'items': [],
          'lastModified': DateTime.now().toIso8601String(),
          'documents': [
            {
              'name': 'ุฑุฎุตุฉ ุงูุนูู',
              'number': 'WP789456',
              'expiryDate': '2025-06-30T00:00:00.000Z',
              'createdAt': DateTime.now().toIso8601String(),
            },
            {
              'name': 'ุงูุฅูุงูุฉ',
              'number': 'RP123789',
              'expiryDate': '2026-03-15T00:00:00.000Z',
              'createdAt': DateTime.now().toIso8601String(),
            },
          ],
        },
      ],

      // ุจูุงูุงุช ุงููุนุงููุงุช
      'transactions': [
        {
          'content': 'ูุชุงุจุนุฉ ุชุฌุฏูุฏ ุฑุฎุตุฉ ุดุฑูุฉ ุงูุชููุฒ',
          'isDone': true,
          'createdAt': '2025-08-01T10:30:00.000Z',
        },
        {
          'content': 'ูุฑุงุฌุนุฉ ุฃูุฑุงู ุงูุนูุงู ุงูุฌุฏุฏ',
          'isDone': false,
          'createdAt': '2025-08-02T14:15:00.000Z',
        },
        {
          'content': 'ุชุญุฏูุซ ุจูุงูุงุช ูุคุณุณุฉ ุงูุจูุงุก ุงูุญุฏูุซ',
          'isDone': true,
          'createdAt': '2025-08-03T09:45:00.000Z',
        },
        {
          'content': 'ุฅุฑุณุงู ุงูุชุฐููุฑุงุช ููุญุณุงุจุงุช ุงููุณุชุญูุฉ',
          'isDone': false,
          'createdAt': '2025-08-04T16:20:00.000Z',
        },
        {
          'content': 'ุฅุนุฏุงุฏ ุชูุฑูุฑ ุดูุฑู ููุดุฑูุงุช ุงููุดุทุฉ',
          'isDone': false,
          'createdAt': '2025-08-05T11:00:00.000Z',
        },
        {
          'content': 'ูุฑุงุฌุนุฉ ุงููุซุงุฆู ุงูููุชููุฉ ุงูุตูุงุญูุฉ',
          'isDone': true,
          'createdAt': '2025-08-06T13:30:00.000Z',
        },
        {
          'content': 'ุชุญุฏูุซ ุฃุฑูุงู ุงูููุงุชู ููุนูุงู',
          'isDone': false,
          'createdAt': '2025-08-07T08:15:00.000Z',
        },
        {
          'content': 'ุฃุฑุดูุฉ ุงูุดุฑูุงุช ุบูุฑ ุงููุดุทุฉ',
          'isDone': true,
          'createdAt': '2025-08-07T15:45:00.000Z',
        },
      ],

      'summary': {
        'total_companies': 3,
        'total_accounts': 5,
        'total_transactions': 8,
      },
    },
  };

  // ุงุฎุชุจุงุฑ ุชุญููู ุงูุจูุงูุงุช ุฅูู JSON
  print('๐ ุงุฎุชุจุงุฑ 1: ุชุญููู ุงูุจูุงูุงุช ุฅูู JSON...');
  try {
    final jsonString = jsonEncode(testBackupData);
    print('   โ ูุฌุญ ุชุญููู ุงูุจูุงูุงุช ุฅูู JSON');
    print('   ๐ ุญุฌู ุงูุจูุงูุงุช: ${jsonString.length} ุญุฑู');
    print(
      '   ๐ฆ ุญุฌู ุงูุจูุงูุงุช: ${(jsonString.length / 1024).toStringAsFixed(2)} KB',
    );
  } catch (e) {
    print('   โ ูุดู ูู ุชุญููู ุงูุจูุงูุงุช: $e');
    return;
  }

  // ุงุฎุชุจุงุฑ ูุฑุงุกุฉ ููู ุชุดููุฑ JSON
  print('\n๐ ุงุฎุชุจุงุฑ 2: ูุฑุงุกุฉ ููู ุชุดููุฑ JSON...');
  try {
    final jsonString = jsonEncode(testBackupData);
    final decodedData = jsonDecode(jsonString);
    print('   โ ูุฌุญ ูู ุชุดููุฑ ุงูุจูุงูุงุช');
    print('   ๐ ุงูุฅุตุฏุงุฑ: ${decodedData['version']}');
    print('   ๐ ุชุงุฑูุฎ ุงูุชุตุฏูุฑ: ${decodedData['exported_at']}');
  } catch (e) {
    print('   โ ูุดู ูู ูู ุงูุชุดููุฑ: $e');
    return;
  }

  // ุงุฎุชุจุงุฑ ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช
  print('\n๐ ุงุฎุชุจุงุฑ 3: ุงุณุชุฎุฑุงุฌ ูุชุญููู ุงูุจูุงูุงุช...');
  try {
    final data = testBackupData['data'] as Map<String, dynamic>;

    print('   ๐ ุฅุญุตุงุฆูุงุช ุงูุจูุงูุงุช:');
    print('      ๐ข ุนุฏุฏ ุงูุดุฑูุงุช: ${data['companies_count']}');
    print('      ๐ฅ ุนุฏุฏ ุงูุญุณุงุจุงุช: ${data['accounts_count']}');
    print('      ๐ฐ ุนุฏุฏ ุงููุนุงููุงุช: ${data['transactions_count']}');

    // ุชุญููู ุจูุงูุงุช ุงูุดุฑูุงุช
    final companies = data['companies'] as List;
    final activeCompanies = companies
        .where((c) => !(c['isArchived'] as bool))
        .length;
    final archivedCompanies = companies
        .where((c) => c['isArchived'] as bool)
        .length;
    final totalWorkers = companies.fold<int>(
      0,
      (sum, c) => sum + (c['workers'] as List).length,
    );

    print('      ๐ ุงูุดุฑูุงุช ุงููุดุทุฉ: $activeCompanies');
    print('      ๐ฆ ุงูุดุฑูุงุช ุงููุคุฑุดูุฉ: $archivedCompanies');
    print('      ๐ท ุฅุฌูุงูู ุงูุนูุงู: $totalWorkers');

    // ุชุญููู ุจูุงูุงุช ุงูุญุณุงุจุงุช
    final accounts = data['accounts'] as List;
    final totalDue = accounts.fold<double>(
      0,
      (sum, a) => sum + (a['totalDue'] as double),
    );
    final totalPaid = accounts.fold<double>(
      0,
      (sum, a) => sum + (a['totalPaid'] as double),
    );
    final totalRemaining = accounts.fold<double>(
      0,
      (sum, a) => sum + (a['remaining'] as double),
    );
    final accountsWithDocuments = accounts
        .where((a) => (a['documents'] as List).isNotEmpty)
        .length;

    print('      ๐ต ุฅุฌูุงูู ุงููุณุชุญูุงุช: ${totalDue.toStringAsFixed(2)} ุฑูุงู');
    print('      ๐ฐ ุฅุฌูุงูู ุงููุฏููุน: ${totalPaid.toStringAsFixed(2)} ุฑูุงู');
    print('      ๐ ุงููุชุจูู: ${totalRemaining.toStringAsFixed(2)} ุฑูุงู');
    print('      ๐ ุญุณุงุจุงุช ุจูุซุงุฆู: $accountsWithDocuments');

    // ุชุญููู ุจูุงูุงุช ุงููุนุงููุงุช
    final transactions = data['transactions'] as List;
    final completedTransactions = transactions
        .where((t) => t['isDone'] as bool)
        .length;
    final pendingTransactions = transactions
        .where((t) => !(t['isDone'] as bool))
        .length;

    print('      โ ุงููุนุงููุงุช ุงูููุชููุฉ: $completedTransactions');
    print('      โณ ุงููุนุงููุงุช ุงููุนููุฉ: $pendingTransactions');

    print('   โ ูุฌุญ ุชุญููู ุฌููุน ุงูุจูุงูุงุช');
  } catch (e) {
    print('   โ ูุดู ูู ุชุญููู ุงูุจูุงูุงุช: $e');
    return;
  }

  // ุงุฎุชุจุงุฑ ุชุญููู ุฅูู CSV
  print('\n๐ ุงุฎุชุจุงุฑ 4: ุชุญููู ุงูุจูุงูุงุช ุฅูู CSV...');
  try {
    final csvContent = convertToCSV(testBackupData);
    final csvLines = csvContent.split('\n').length;
    print('   โ ูุฌุญ ุชุญููู ุงูุจูุงูุงุช ุฅูู CSV');
    print('   ๐ ุนุฏุฏ ุงูุฃุณุทุฑ: $csvLines');
    print('   ๐ฆ ุญุฌู ุงููุญุชูู: ${csvContent.length} ุญุฑู');

    // ุนุฑุถ ุนููุฉ ูู CSV
    final sampleLines = csvContent.split('\n').take(10).join('\n');
    print('   ๐ ุนููุฉ ูู ุงููุญุชูู:');
    print('$sampleLines...');
  } catch (e) {
    print('   โ ูุดู ูู ุชุญููู ุฅูู CSV: $e');
  }

  // ุงุฎุชุจุงุฑ ุงูุชุญูู ูู ุณูุงูุฉ ุงูุจูุงูุงุช
  print('\n๐ ุงุฎุชุจุงุฑ 5: ุงูุชุญูู ูู ุณูุงูุฉ ุงูุจูุงูุงุช...');
  try {
    validateBackupData(testBackupData);
    print('   โ ุฌููุน ุงูุจูุงูุงุช ุณูููุฉ ูุตุญูุญุฉ');
  } catch (e) {
    print('   โ ุฎุทุฃ ูู ุณูุงูุฉ ุงูุจูุงูุงุช: $e');
  }

  print('\n๐ ุงูุชูู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู ุจูุฌุงุญ!');
  print('โจ ูุธุงู ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ ุฌุงูุฒ ููุงุณุชุฎุฏุงู');
  print('๐ ุฌููุน ุงูุจูุงูุงุช ุขููุฉ ููุญููุฉ');
  print('๐ฑ ุงูุชุทุจูู ุฌุงูุฒ ููุฅูุชุงุฌ');
}

/// ุชุญููู ุงูุจูุงูุงุช ุฅูู ุตูุบุฉ CSV
String convertToCSV(Map<String, dynamic> data) {
  final buffer = StringBuffer();

  // ุฅุถุงูุฉ ูุนูููุงุช ุงูุชุตุฏูุฑ
  buffer.writeln('ุชูุฑูุฑ ุชููุฒ ุฅุฏุงุฑู');
  buffer.writeln('ุชุงุฑูุฎ ุงูุชุตุฏูุฑ: ${data['exported_at']}');
  buffer.writeln('ุงูุฅุตุฏุงุฑ: ${data['version']}');
  buffer.writeln();

  // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุดุฑูุงุช
  if (data['data']['companies'] != null &&
      data['data']['companies'].isNotEmpty) {
    buffer.writeln('=== ุงูุดุฑูุงุช ===');
    buffer.writeln('ุงุณู ุงูุดุฑูุฉ,ุฑูู ุงููุงูู,ูุงุชู ุงููุงูู,ุญุงูุฉ ุงูุฃุฑุดูู,ุนุฏุฏ ุงูุนูุงู');
    for (var company in data['data']['companies']) {
      final workersCount = (company['workers'] as List?)?.length ?? 0;
      buffer.writeln(
        '${company['name']},${company['ownerId']},${company['ownerPhone']},${company['isArchived'] ? 'ูุคุฑุดู' : 'ูุดุท'},$workersCount',
      );
    }
    buffer.writeln();
  }

  // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุญุณุงุจุงุช
  if (data['data']['accounts'] != null && data['data']['accounts'].isNotEmpty) {
    buffer.writeln('=== ุงูุญุณุงุจุงุช ===');
    buffer.writeln(
      'ุงุณู ุงูุญุณุงุจ,ุฅุฌูุงูู ุงููุณุชุญูุงุช,ุฅุฌูุงูู ุงููุฏููุน,ุงููุชุจูู,ุชุงุฑูุฎ ุงูุงุณุชุญูุงู,ุนุฏุฏ ุงููุซุงุฆู',
    );
    for (var account in data['data']['accounts']) {
      final documentsCount = (account['documents'] as List?)?.length ?? 0;
      buffer.writeln(
        '${account['name']},${account['totalDue']},${account['totalPaid']},${account['remaining']},${account['dueDate']?.split('T')[0] ?? ''},${documentsCount}',
      );
    }
    buffer.writeln();
  }

  // ุฅุถุงูุฉ ุจูุงูุงุช ุงููุนุงููุงุช
  if (data['data']['transactions'] != null &&
      data['data']['transactions'].isNotEmpty) {
    buffer.writeln('=== ุงููุนุงููุงุช ===');
    buffer.writeln('ุงููุญุชูู,ุญุงูุฉ ุงูุฅูุฌุงุฒ,ุชุงุฑูุฎ ุงูุฅูุดุงุก');
    for (var transaction in data['data']['transactions']) {
      buffer.writeln(
        '${transaction['content']},${transaction['isDone'] ? 'ููุชูู' : 'ููุฏ ุงูุงูุชุธุงุฑ'},${transaction['createdAt']?.split('T')[0] ?? ''}',
      );
    }
    buffer.writeln();
  }

  // ุฅุถุงูุฉ ุงูููุฎุต
  buffer.writeln('=== ุงูููุฎุต ===');
  buffer.writeln('ุฅุฌูุงูู ุงูุดุฑูุงุช,${data['data']['companies_count']}');
  buffer.writeln('ุฅุฌูุงูู ุงูุญุณุงุจุงุช,${data['data']['accounts_count']}');
  buffer.writeln('ุฅุฌูุงูู ุงููุนุงููุงุช,${data['data']['transactions_count']}');

  return buffer.toString();
}

/// ุงูุชุญูู ูู ุณูุงูุฉ ุจูุงูุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
void validateBackupData(Map<String, dynamic> backupData) {
  // ุงูุชุญูู ูู ูุฌูุฏ ุงูุญููู ุงูุฃุณุงุณูุฉ
  if (backupData['version'] == null) {
    throw Exception('ุญูู ุงูุฅุตุฏุงุฑ ููููุฏ');
  }

  if (backupData['exported_at'] == null) {
    throw Exception('ุชุงุฑูุฎ ุงูุชุตุฏูุฑ ููููุฏ');
  }

  if (backupData['data'] == null) {
    throw Exception('ุจูุงูุงุช ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ููููุฏุฉ');
  }

  final data = backupData['data'] as Map<String, dynamic>;

  // ุงูุชุญูู ูู ุงูุฅุญุตุงุฆูุงุช
  if (data['companies_count'] == null ||
      data['accounts_count'] == null ||
      data['transactions_count'] == null) {
    throw Exception('ุฅุญุตุงุฆูุงุช ุงูุจูุงูุงุช ููููุฏุฉ');
  }

  // ุงูุชุญูู ูู ุชุทุงุจู ุงูุฅุญุตุงุฆูุงุช ูุน ุงูุจูุงูุงุช ุงููุนููุฉ
  if (data['companies'] != null) {
    final actualCount = (data['companies'] as List).length;
    final reportedCount = data['companies_count'] as int;
    if (actualCount != reportedCount) {
      throw Exception('ุนุฏุฏ ุงูุดุฑูุงุช ุบูุฑ ูุชุทุงุจู: $actualCount != $reportedCount');
    }
  }

  if (data['accounts'] != null) {
    final actualCount = (data['accounts'] as List).length;
    final reportedCount = data['accounts_count'] as int;
    if (actualCount != reportedCount) {
      throw Exception(
        'ุนุฏุฏ ุงูุญุณุงุจุงุช ุบูุฑ ูุชุทุงุจู: $actualCount != $reportedCount',
      );
    }
  }

  if (data['transactions'] != null) {
    final actualCount = (data['transactions'] as List).length;
    final reportedCount = data['transactions_count'] as int;
    if (actualCount != reportedCount) {
      throw Exception(
        'ุนุฏุฏ ุงููุนุงููุงุช ุบูุฑ ูุชุทุงุจู: $actualCount != $reportedCount',
      );
    }
  }
}
